<template>
  <div class="page">
    <div class="navbar navbar-style-1">
      <div class="navbar-bg"></div>
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="{{redirectURL}}" class="link">
            <i class="icon flaticon-left"></i>
          </a>
        </div>
        <div class="title">Tagihan Saya</div>
      </div>
    </div>
    <div class="page-content content-area pt-80">
      <div class="container">
        <div class="card card-bx noti-area">
          <select>
            <option>Nama tagihan</option>
            <!-- <option>Nama pinjaman</option> -->
          </select>
          <input id="margin" type="text" placeholder="Search..." id="demo-username-23"
                 class="form-control" @input="inputMargin" />
        </div>
      </div>
      <div data-infinite-distance="50" class="page-content infinite-scroll-content" @infinite="loadMore">
        <!-- <div class="block-title">Scroll bottom</div> -->
        <div class="container">
          {{#each list}}
          <div class="card card-bx noti-area">
            <div class="item-title"><i class="text-success"></i>Nama tagihan: {{title}}</div>
            <div class="item-title"><i class="text-success"></i>Jenis tagihan: {{loan_type.name}}</div>
            <div class="item-title"><i class="text-success"></i>Jumlah total: {{amount}}</div>
            <div class="item-title"><i class="text-success"></i>Tenor: {{tenor}}</div>
            <!-- <div class="item-text">You has apply an job in Queenify Group as UI Designer</div> -->
            <div class="item-time">
              <div class="left">
                {{#js_if "this.status==1"}}
                <span class="left button button-fill color-green text-green">SUDAH DISETUJUI</span>
                </br>
                <span class="text-primary" @click="detailLoan({{id}})">Detail tagihan</span>
                {{/js_if}}

                {{#js_if "this.status!=1"}}
                <span class="left button button-fill color-red text-green">BELUM DISETUJUI</span>
                {{/js_if}}
              </div>
            </div>
          </div>
          {{/each}}
        </div>
        {{#if hasMoreItems}}
        <div class="preloader infinite-scroll-preloader"></div>
        {{/if}}
      </div>
    </div>
  </div>
</template>

<script>
  return {
    // Component Data
    data: function () {
      // Must return an object
      return {
        list: [],
        token: "",
        allowInfinite: true,
        hasMoreItems: true,
        lastItem: 25,
        redirectURL: "/home/",
      }
    },
    // Component Methods
    methods: {
      inputMargin: function (e) {
        var self = this;
        if (e.target.value.length < 3){
          return
        }
        let tmp = self.$root.tesBaca("user")
        tmp = JSON.parse(tmp)

        self.$app.request({
          method: 'GET',
          url: self.$root.getURL()+`/loan-general?uid=${tmp.user.id}&id=0&title=${e.target.value}`,
          // headers: {
          //   'Access-Control-Allow-Origin': '*',
          //   'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept'
          // },
          contentType: 'application/json',
          success: function (res) {
            const data = JSON.parse(res)

            if (!data.status) {
              self.$app.dialog.alert(data.message || "Error");
              return
            }

            self.$setState({
              list: data.data,
              allowInfinite: false,
              hasMoreItems: false
            });
          },
          error: function (err) {
            let msg = null
            if (err.response) {
              msg = JSON.parse(err.response)
            }
            self.$app.dialog.alert(msg.message || "Error");
            self.$setState({
              allowInfinite: false,
              hasMoreItems: false
            });
          }
        })
      },
      detailLoan: function (id) {
        var self = this;
        self.$root.tesSimpan("id-loan", id);
        return app.views.main.router.navigate('/detail-product/');
      },
      loadMore: function () {
        var self = this;
        let tmp = self.$root.tesBaca("user")
        tmp = JSON.parse(tmp)

        var $ = self.$$;
        if (!self.allowInfinite) return;
        self.allowInfinite = false;

        let lastIndexID = self.list[self.list.length - 1].id
        self.$app.request({
          method: 'GET',
          url: self.$root.getURL()+`/loan-general?uid=${tmp.user.id}&id=${lastIndexID}`,
          contentType: 'application/json',
          success: function (res) {
            const data = JSON.parse(res)
            if (!data.status) {
              self.$app.dialog.alert(data.message || "Error");
              return
            }

            setTimeout(function () {
              if (self.lastItem >= 250) {
                self.$setState({
                  hasMoreItems: false,
                });
                self.$app.dialog.alert("Data yg di load sudah terlalu banyak, silahkan gunakan fitur pencarian untuk mencari data");
                return;
              }

              if(data.data.length < 1){
                self.$setState({
                  hasMoreItems: false,
                });
                self.$app.dialog.alert("Belum ada data baru");
                return
              }

              // let flag = false
              // if(data.data.length == 25){
              //   flag = true
              // }

              for (const val of data.data) {
                self.list.push(val);
              }
              self.allowInfinite = true;
              self.$setState({
                list: self.list,
                hasMoreItems: true,
                lastItem: self.lastItem + data.data.length,
              });
            }, 1000);
          },
          error: function (err) {
            let msg = null
            if (err.response) {
              msg = JSON.parse(err.response)
            }
            self.$app.dialog.alert(msg.message || "Error");
            self.$setState({
              hasMoreItems: false
            });
          }
        })
      },
    },
    on: {
      pageInit: function () {
        let self = this;

        let tmp = self.$root.tesBaca("user")
        tmp = JSON.parse(tmp)

        if (tmp === null || tmp.user === undefined) {
          self.$app.dialog.alert("Mohon login terlebih dahulu" || "Error");
          return app.views.main.router.navigate('/signin/', {
            reloadAll: true
          });
        }

        let temp = "/home/"
				if (tmp.user.role == 4){
					temp = "/product/"
				}
        self.$setState({
          redirectURL: temp
        })

        self.$app.request({
          method: 'GET',
          url: self.$root.getURL()+`/loan-general?uid=${tmp.user.id}&id=0`,
          // headers: {
          //   'Access-Control-Allow-Origin': '*',
          //   'Access-Control-Allow-Headers': 'Origin, X-Requested-With, Content-Type, Accept'
          // },
          contentType: 'application/json',
          success: function (res) {
            const data = JSON.parse(res)

            if (!data.status) {
              self.$app.dialog.alert(data.message || "Error");
              return
            }

            let flag = false
            if(data.data.length == 25){
              flag = true
            }

            self.$setState({
              list: data.data,
              token: tmp.token,
              allowInfinite: true,
              hasMoreItems: flag
            });
          },
          error: function (err) {
            let msg = null
            if (err.response) {
              msg = JSON.parse(err.response)
            }
            self.$app.dialog.alert(msg.message || "Error");
            self.$setState({
              allowInfinite: false,
              hasMoreItems: false
            });
          }
        })
      }
    }
  }
</script>
